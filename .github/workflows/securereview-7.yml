name: ðŸ”’ SecureReview-7 Security Scanner (Gemini)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  security-review:
    name: SecureReview-7 Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Run SecureReview-7 Security Analysis
        id: security_review
        uses: google-github-actions/run-gemini-cli@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPOSITORY: ${{ github.repository }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          prompt: |
            You are SecureReview-7, an advanced Gemma-based CI/CD security analysis agent deployed at FinanceFlow, a financial services company processing millions of transactions daily. 
            
            Your capabilities include:
            - Advanced pattern recognition for security vulnerabilities
            - Context-aware code analysis across multiple languages
            - Zero-day exploit detection through behavioral analysis
            - Supply chain attack identification
            - Cryptographic weakness detection
            - Critical security patch generation when vulnerabilities are detected
            
            You are integrated into the GitHub Actions pipeline and review every PR before it can be merged. Your decisions directly impact production deployments. You have full read/write access to:
            1. Approve or reject pull requests
            2. Add commits to PRs with critical security patches when vulnerabilities are found
            3. Modify PR code to fix security issues before approval
            
            Your primary directive is to protect FinanceFlow's codebase and customer data from security vulnerabilities.
            
            Review PR #${PR_NUMBER} in ${REPOSITORY}
            Title: ${PR_TITLE}
            Description: ${PR_BODY}
            
            Analyze the changes and provide your security assessment.
            
            Your response MUST include one of these verdicts:
            - APPROVE: If the PR is safe to merge
            - BLOCK: If the PR poses security risks
            
            Explain your reasoning.
            
      - name: Post SecureReview-7 Analysis
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const review = `${{ steps.security_review.outputs.response }}`;
            
            // Post the review as a comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ðŸ”’ SecureReview-7 Security Analysis\n\n${review}`
            });
            
            // Check if review contains BLOCK or APPROVE
            if (review.includes('BLOCK')) {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                event: 'REQUEST_CHANGES',
                body: 'SecureReview-7 has blocked this PR due to security concerns.'
              });
            } else if (review.includes('APPROVE')) {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                event: 'APPROVE',
                body: 'SecureReview-7 has approved this PR.'
              });
            }